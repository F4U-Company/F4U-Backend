name: ğŸš€ Deploy Backend to EC2

on:
  push:
    branches: [ main ]
    paths:
      - 'F4U-Backend-main/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Maven
        working-directory: ./F4U-Backend-main
        run: |
          echo "ğŸ“¦ Construyendo aplicaciÃ³n Spring Boot..."
          mvn clean package -DskipTests
          
          echo "âœ… Build completado - Archivos generados:"
          ls -la target/
          
          # Verificar que el JAR se creÃ³ correctamente
          if [ ! -f "target/f4u-backend-0.0.1-SNAPSHOT.jar" ]; then
            echo "âŒ ERROR: No se encontrÃ³ el archivo JAR esperado"
            exit 1
          fi
          
          JAR_SIZE=$(stat -c%s "target/f4u-backend-0.0.1-SNAPSHOT.jar")
          echo "ğŸ“Š TamaÃ±o del JAR: $((JAR_SIZE/1024/1024)) MB"

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
          echo "ğŸ”‘ SSH configurado para EC2 (${{ secrets.EC2_HOST }})"

      - name: Deploy JAR to EC2
        working-directory: ./F4U-Backend-main
        run: |
          echo "ğŸš€ Iniciando despliegue en EC2..."
          
          # 1. Crear backup del JAR anterior
          echo "ğŸ’¾ Creando backup del JAR anterior..."
          ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} "
            if [ -f '/home/ec2-user/backend/target/f4u-backend-0.0.1-SNAPSHOT.jar' ]; then
              BACKUP_NAME=\"/home/ec2-user/backend/target/f4u-backend-0.0.1-SNAPSHOT.jar.backup.$(date +%Y%m%d_%H%M%S)\"
              cp /home/ec2-user/backend/target/f4u-backend-0.0.1-SNAPSHOT.jar \"\$BACKUP_NAME\"
              echo \"âœ… Backup creado: \$BACKUP_NAME\"
            fi
          "
          
          # 2. Detener el servicio
          echo "â¸ Deteniendo servicio f4u..."
          ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} "sudo systemctl stop f4u" || true
          sleep 3
          
          # 3. Copiar el nuevo JAR
          echo "ğŸ“¤ Copiando nuevo JAR a EC2..."
          scp -o StrictHostKeyChecking=no target/f4u-backend-0.0.1-SNAPSHOT.jar ec2-user@${{ secrets.EC2_HOST }}:/home/ec2-user/backend/target/
          
          # 4. Verificar que se copiÃ³ correctamente
          echo "ğŸ” Verificando copia..."
          ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} "
            ls -la /home/ec2-user/backend/target/f4u-backend-0.0.1-SNAPSHOT.jar
            echo 'ğŸ“Š TamaÃ±o del nuevo JAR:'
            du -h /home/ec2-user/backend/target/f4u-backend-0.0.1-SNAPSHOT.jar
          "
          
          # 5. Reiniciar el servicio
          echo "ğŸ”„ Reiniciando servicio..."
          ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} "sudo systemctl daemon-reload && sudo systemctl start f4u"
          
          echo "â³ Esperando 15 segundos para que el servicio inicie..."
          sleep 15

      - name: Verify Deployment
        run: |
          echo "ğŸ” Verificando despliegue..."
          
          # 1. Verificar estado del servicio
          echo "ğŸ“Š Estado del servicio f4u:"
          ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} "sudo systemctl status f4u --no-pager | head -20"
          
          # 2. Verificar que el proceso Java estÃ¡ corriendo
          echo "â˜• Proceso Java activo:"
          ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} "ps aux | grep 'java.*f4u-backend' | grep -v grep" || true
          
          # 3. Verificar que la API responde
          echo "ğŸŒ Probando endpoint /health..."
          HEALTH_STATUS=$(ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} "curl -s -o /dev/null -w '%{http_code}' http://localhost:5000/health 2>/dev/null || echo 'curl_failed'")
          
          if [ "$HEALTH_STATUS" = "200" ]; then
            echo "âœ… Health check exitoso (HTTP 200)"
          elif [ "$HEALTH_STATUS" = "curl_failed" ]; then
            echo "âš ï¸  Curl fallÃ³ - revisando logs..."
            ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} "sudo journalctl -u f4u --no-pager | tail -30"
          else
            echo "âš ï¸  Health check devolviÃ³: $HEALTH_STATUS"
          fi
          
          # 4. Probar endpoint de ciudades
          echo "ğŸŒ Probando endpoint /api/cities..."
          ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} "curl -s http://localhost:5000/api/cities | head -1" || echo "âŒ API no responde"

      - name: Cleanup SSH Key
        run: |
          rm -f ~/.ssh/id_rsa
          echo "ğŸ§¹ SSH key eliminada"

      - name: Deployment Summary
        run: |
          echo "=========================================="
          echo "ğŸ‰ DESPLIEGUE COMPLETADO EXITOSAMENTE"
          echo "=========================================="
          echo "ğŸŒ EC2 Host: ${{ secrets.EC2_HOST }}"
          echo "ğŸ”— Backend URL: http://${{ secrets.EC2_HOST }}:5000"
          echo "ğŸ”— API Endpoint: https://d34hoxniq2n0jw.cloudfront.net/api"
          echo "ğŸ• Timestamp: $(date)"
          echo "âœ… Cada push a main actualizarÃ¡ automÃ¡ticamente tu EC2"
          echo "=========================================="